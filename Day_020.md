# Day 20: Configure Nginx + PHP-FPM Using Unix Sock

The Nautilus application development team is planning to launch a new PHP-based application, which they want to deploy on Nautilus infra in Stratos DC. The development team had a meeting with the production support team and they have shared some requirements regarding the infrastructure. Below are the requirements they shared:

* Install `nginx` on `app server 1` , configure it to use port `8093` and its document root should be `/var/www/html`.
* Install php-fpm version 8.3 on `app server 1`, it must use the unix socket `/var/run/php-fpm/default.sock` (create the parent directories if don't exist).
* Configure `php-fpm` and `nginx` to work together.
* Once configured correctly, you can test the website using `curl http://stapp01:8093/index.php` command from jump host.


## Solution
1. Install nginx and start it on `app server 1`
```sh
sudo yum install nginx -y
sudo systemctl start nginx
sudo systemctl enable nginx
```


> Edit nginx config file to update `port`, `servername`, and document root path for `/var/www/html`


2. Install `php-fpm` and `cat /etc/redhat-release`, if output is 9, then proceed with below commands
```sh
sudo dnf install -y https://rpms.remirepo.net/enterprise/remi-release-9.rpm
sudo dnf module reset php -y
sudo dnf module enable php:remi-8.3 -y
sudo dnf install -y php-fpm php-cli php-mysqlnd php-pdo php-gd php-mbstring php-xml php-json php-opcache
```


3. Once php-fpm is installed, start and verify the installation
```sh
sudo systemctl start php-fpm
sudo systemctl enable php-fpm
php -v
```


4. Next update the unit sock file and required fields in php-fpm config file as like below
> sudo vi /etc/php-fpm.d/www.conf --> listen = /var/run/php-fpm/default.sock --> user = nginx --> group = nginx


5. Restart php-fpm, create parent dir and enable it
```sh
sudo systemctl restart php-fpm
sudo mkdir -p /var/run/php-fpm
sudo chown nginx:nginx /var/run/php-fpm
sudo systemctl enable --now php-fpm
```


6. Edit the nginx.conf file and update the following fields.
```sh
sudo vi /etc/nginx/nginx.conf, 
    index        index.php index.html index.htm;

    location ~ \.php$ {
        include        fastcgi_params;
        fastcgi_pass   unix:/var/run/php-fpm/default.sock;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
```


7. Finally restart php-fpm and nginx
```sh
sudo systemctl restart php-fpm
sudo systemctl restart nginx
```


8. Verify the same using curl command
```sh
curl http://stapp01:8093/index.php
```
